<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Komunitas Anak Rantau - Mangkok & Cerita</title>
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>

  <header>
    <h1><a href="index.html" style="text-decoration:none; color:inherit;">Mangkok & Cerita</a></h1>
    <nav>
      <a href="komunitas.html" class="nav-icon">
        Komunitas
      </a>
      
      <a href="checkout.html" class="nav-icon nav-btn">
        <img src="https://cdn-icons-png.flaticon.com/128/3514/3514491.png" alt="Cart" style="filter: brightness(0) invert(1);" width="18" height="18">
        Keranjang <span id="cart-count" style="margin-left:5px; background:white; color:#9b4922; border-radius:10px; padding:0 6px; font-size:0.8rem; font-weight:bold;">0</span>
      </a>
    </nav>
  </header>

<main class="forum-section">
  <div class="forum-container">
    
    <!-- Input Section -->
    <div class="post-form-card">
      <h3>
        <img src="https://cdn-icons-png.flaticon.com/128/2921/2921222.png" alt="Edit" width="24">
        Bagikan Ceritamu
      </h3>
      
      <div class="form-group">
        <input type="text" id="username" class="form-input" placeholder="Nama Kamu (Boleh Samaran)" required />
      </div>
      
      <div class="form-group">
        <input type="text" id="title" class="form-input" placeholder="Judul Topik Seru" required />
      </div>
      
      <div class="form-group">
        <textarea id="content" class="form-textarea" placeholder="Apa yang sedang kamu rasakan atau alami di perantauan? Ceritakan di sini..." required></textarea>
      </div>
      
      <div style="overflow: hidden;">
        <button id="submitPost" class="submit-post-btn">Posting Cerita</button>
      </div>
    </div>

    <!-- Feed Section -->
    <div class="feed-filter">
      <button class="filter-btn active" id="btnNewest">Terbaru</button>
      <button class="filter-btn" id="btnOldest">Terlama</button>
    </div>

    <div id="feed">
        <!-- Posts will be rendered here -->
    </div>

  </div>
</main>

<script>
  const feed = document.getElementById("feed");
  const submitPost = document.getElementById("submitPost");
  const btnNewest = document.getElementById("btnNewest");
  const btnOldest = document.getElementById("btnOldest");
  
  let posts = JSON.parse(localStorage.getItem("posts")) || [];
  let isReversed = false; // Default: Newest first

  // Helper function to get random avatar color
  function getAvatarColor(name) {
      const colors = ['#e74c3c', '#3498db', '#2ecc71', '#f1c40f', '#9b59b6', '#e67e22', '#1abc9c'];
      let hash = 0;
      for (let i = 0; i < name.length; i++) {
          hash = name.charCodeAt(i) + ((hash << 5) - hash);
      }
      return colors[Math.abs(hash) % colors.length];
  }

  function renderPosts() {
    feed.innerHTML = "";
    
    // Determine order
    let displayPosts = isReversed ? [...posts].reverse() : posts;

    if (displayPosts.length === 0) {
        feed.innerHTML = `
            <div style="text-align:center; padding: 40px; color:#777;">
                <img src="https://cdn-icons-png.flaticon.com/128/7486/7486747.png" width="80" style="opacity:0.5; margin-bottom:15px;">
                <p>Belum ada cerita nih. Jadilah yang pertama berbagi!</p>
            </div>
        `;
        return;
    }

    displayPosts.forEach((post, i) => {
      // Must map back to original index for editing/deleting if reversed
      // But for simplicity, we'll find the index in original 'posts' array or use ID if we had one.
      // Since we don't have IDs, we will stick to visual rendering issues.
      // FIX: The action buttons (like/delete) use 'index'. If we reverse, the index 'i' is wrong relative to 'posts'.
      // We need to pass the ACTUAL index of the post in the original 'posts' array.
      
      const originalIndex = isReversed ? (posts.length - 1 - i) : i;
      
      const card = document.createElement("div");
      card.className = "post-card";
      
      // Initials for avatar
      const initials = post.username.substring(0, 2).toUpperCase();
      const avatarColor = getAvatarColor(post.username);

      card.innerHTML = `
        <div class="post-header">
          <div class="user-avatar" style="background-color: ${avatarColor}; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.9rem;">${initials}</div>
          <div class="user-info">
            <strong>${post.username}</strong>
            <span>${post.time}</span>
          </div>
        </div>

        <div class="post-body">
            <h4>${post.title}</h4>
            <p>${post.content}</p>
        </div>

        <div class="post-footer">
          <button class="action-btn like" data-index="${originalIndex}">
             ${post.likes || 0} Suka
          </button>
          <button class="action-btn comment-toggle" data-index="${originalIndex}">
             ${post.comments?.length || 0} Komentar
          </button>
          <button class="action-btn share" data-index="${originalIndex}">
             Bagikan
          </button>
          <div style="margin-left: auto;">
             <button class="action-btn delete" data-index="${originalIndex}" style="color: #e74c3c;">Hapus</button>
          </div>
        </div>

        <div class="comments-container" id="comments-${originalIndex}">
          <div id="comment-list-${originalIndex}">
            ${(post.comments || [])
              .map((c, i) => `
                <div class="comment-item">
                     <div class="user-avatar" style="width: 30px; height: 30px; font-size: 0.7rem; background-color: ${getAvatarColor(c.user)}; color:white; display:flex; align-items:center; justify-content:center;">${c.user.substring(0,1).toUpperCase()}</div>
                    <div class="comment-bubble">
                        <strong>${c.user}</strong>
                        <p>${c.text}</p>
                    </div>
                </div>
              `)
              .join("")}
          </div>

          <form class="comment-form" data-index="${originalIndex}" style="margin-top: 15px; display:flex; gap:10px;">
            <input type="text" placeholder="Nama" class="comment-user form-input" style="width:30%;" required />
            <input type="text" placeholder="Tulis komentar..." class="comment-text form-input" style="flex:1;" required />
            <button type="submit" class="submit-post-btn" style="padding: 10px 15px;">â†’</button>
          </form>
        </div>
      `;
      feed.appendChild(card);
    });
  }

  // Sorting Events
  btnNewest.addEventListener("click", () => {
    isReversed = false;
    btnNewest.classList.add("active");
    btnOldest.classList.remove("active");
    renderPosts();
  });

  btnOldest.addEventListener("click", () => {
    isReversed = true;
    btnOldest.classList.add("active");
    btnNewest.classList.remove("active");
    renderPosts();
  });

  submitPost.addEventListener("click", () => {
    const username = document.getElementById("username").value.trim();
    const title = document.getElementById("title").value.trim();
    const content = document.getElementById("content").value.trim();
    
    if (!username || !title || !content) {
        alert("Mohon isi semua kolom untuk berbagi cerita.");
        return;
    }

    const now = new Date();
    // Format date nicely: "Senin, 10 Jan 12.30"
    const options = { weekday: 'long', day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' };
    const time = now.toLocaleDateString("id-ID", options);

    posts.unshift({ username, title, content, time, likes: 0, comments: [] });
    localStorage.setItem("posts", JSON.stringify(posts));
    renderPosts();

    // Reset form
    document.getElementById("username").value = "";
    document.getElementById("title").value = "";
    document.getElementById("content").value = "";
  });

  feed.addEventListener("click", (e) => {
    const likeBtn = e.target.closest(".like");
    const shareBtn = e.target.closest(".share");
    const toggleBtn = e.target.closest(".comment-toggle");
    const deleteBtn = e.target.closest(".delete");

    if (likeBtn) {
      const idx = likeBtn.dataset.index;
      posts[idx].likes++;
      localStorage.setItem("posts", JSON.stringify(posts));
      renderPosts();
    }

    if (shareBtn) {
      const idx = shareBtn.dataset.index;
      const shareText = `*${posts[idx].title}*\n${posts[idx].content}\n\nOleh: ${posts[idx].username} - via Mangkok & Cerita`;
      const waUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(shareText)}`;
      window.open(waUrl, "_blank");
    }

    if (toggleBtn) {
      const idx = toggleBtn.dataset.index;
      const section = document.getElementById(`comments-${idx}`);
      section.classList.toggle("show");
    }

    if (deleteBtn) {
      const idx = deleteBtn.dataset.index;
      if (confirm("Hapus cerita ini?")) {
        posts.splice(idx, 1);
        localStorage.setItem("posts", JSON.stringify(posts));
        renderPosts();
      }
    }
  });

  // Handle Comment Submit
  feed.addEventListener("submit", (e) => {
    e.preventDefault();
    if (!e.target.classList.contains("comment-form")) return;
    
    const idx = e.target.dataset.index;
    const userInput = e.target.querySelector(".comment-user");
    const textInput = e.target.querySelector(".comment-text");
    
    const user = userInput.value.trim();
    const text = textInput.value.trim();
    
    if (!user || !text) return;

    posts[idx].comments.push({ user, text });
    localStorage.setItem("posts", JSON.stringify(posts));
    
    // Better UX: Don't re-render whole feed, just add comment?
    // For simplicity, re-render and re-open the comment section
    renderPosts();
    const section = document.getElementById(`comments-${idx}`);
    section.classList.add("show");
  });

  renderPosts();
</script>

<script src="script.js"></script>
</body>
</html>
